---
import Layout from '../layouts/Layout.astro';
import { supabase } from '../lib/supabase';

// Get table names to see what's available
let tables = [];
let sampleData = null;
let tableName = '';

try {
  // Try to get table names (this might not work with Supabase permissions)
  const { data: tableData, error: tableError } = await supabase
    .from('information_schema.tables')
    .select('table_name')
    .eq('table_schema', 'public');
  
  if (!tableError) {
    tables = tableData || [];
  }
} catch (error) {
  console.log('Could not fetch table names, will try direct table access');
}

// Try to access common table names for Express Entry draws
const possibleTableNames = [
  'express_entry_draws',
  'ee_draws', 
  'express_entry',
  'ee_data',
  'draws',
  'immigration_draws'
];

for (const name of possibleTableNames) {
  try {
    const { data, error } = await supabase
      .from(name)
      .select('*')
      .limit(3);
    
    if (!error && data && data.length > 0) {
      tableName = name;
      sampleData = data;
      break;
    }
  } catch (error) {
    // Table doesn't exist, try next one
  }
}
---

<Layout title="Explore Table Structure | Immigratic">
  <div class="min-h-screen bg-gray-50 py-12">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-center mb-12">
        <h1 class="text-4xl font-bold text-gray-900 mb-4">üîç Explore Table Structure</h1>
        <p class="text-xl text-gray-600">Let's see what's in your new Express Entry draws table</p>
      </div>

      {tableName ? (
        <div class="space-y-8">
          <!-- Table Found -->
          <div class="bg-green-50 border border-green-200 rounded-lg p-6">
            <h2 class="text-2xl font-bold text-green-800 mb-4">‚úÖ Table Found!</h2>
            <p class="text-green-700">
              <strong>Table Name:</strong> <code class="bg-green-100 px-2 py-1 rounded">{tableName}</code>
            </p>
          </div>

          <!-- Sample Data -->
          <div class="bg-white rounded-lg shadow-lg p-6">
            <h3 class="text-xl font-bold text-gray-900 mb-4">üìä Sample Data (First 3 Rows)</h3>
            <div class="overflow-x-auto">
              <pre class="bg-gray-100 p-4 rounded-lg text-sm overflow-x-auto"><code>{JSON.stringify(sampleData, null, 2)}</code></pre>
            </div>
          </div>

          <!-- Column Analysis -->
          {sampleData && sampleData.length > 0 ? (
            <div class="bg-white rounded-lg shadow-lg p-6">
              <h3 class="text-xl font-bold text-gray-900 mb-4">üîç Column Analysis</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                {Object.keys(sampleData[0]).map(column => (
                  <div class="border border-gray-200 rounded-lg p-4">
                    <h4 class="font-semibold text-gray-900 mb-2">{column}</h4>
                    <p class="text-sm text-gray-600">
                      <strong>Type:</strong> {typeof sampleData[0][column]}<br>
                      <strong>Sample Value:</strong> {String(sampleData[0][column]).substring(0, 50)}
                      {String(sampleData[0][column]).length > 50 ? '...' : ''}
                    </p>
                  </div>
                ))}
              </div>
            </div>
          ) : null}
        </div>
      ) : (
        <!-- No Table Found -->
        <div class="bg-red-50 border border-red-200 rounded-lg p-8 text-center">
          <h2 class="text-2xl font-bold text-red-800 mb-4">‚ùå No Table Found</h2>
          <p class="text-red-700 mb-4">
            I couldn't find any of the expected table names. Please provide:
          </p>
          <div class="bg-white rounded-lg p-4 text-left max-w-2xl mx-auto">
            <h3 class="font-bold text-gray-900 mb-2">What I need:</h3>
            <ul class="text-sm text-gray-700 space-y-1">
              <li>‚Ä¢ <strong>Exact table name</strong> (case-sensitive)</li>
              <li>‚Ä¢ <strong>Sample row data</strong> (copy/paste one row)</li>
              <li>‚Ä¢ <strong>Column names</strong> (if you can see them)</li>
            </ul>
          </div>
        </div>
      )}

      <!-- Manual Table Input -->
      <div class="bg-white rounded-lg shadow-lg p-6 mt-8">
        <h3 class="text-xl font-bold text-gray-900 mb-4">üîß Manual Table Check</h3>
        <p class="text-gray-600 mb-4">
          If the automatic detection didn't work, please provide the exact table name:
        </p>
        <div class="bg-gray-50 p-4 rounded-lg">
          <p class="text-sm text-gray-700">
            <strong>Common places to find table name:</strong><br>
            ‚Ä¢ Supabase Dashboard ‚Üí Table Editor ‚Üí Look for your table name<br>
            ‚Ä¢ Check if it's in a different schema (not 'public')<br>
            ‚Ä¢ The name might be slightly different than expected
          </p>
        </div>
      </div>
    </div>
  </div>
</Layout>
